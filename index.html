<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hiring Manager Pro ‚Äî Improved</title>
    <style>
        :root{
            --bg:#f4f7f6; --muted:#777; --card:#fff; --accent:#007bff; --radius:12px;
        }
        html,body{height:100%;}
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); padding:16px; margin:0; }

        /* Dashboard */
        .dashboard{display:flex;gap:8px;overflow-x:auto;margin-bottom:14px;padding-bottom:6px}
        .stat-card{background:var(--card);padding:10px;border-radius:10px;min-width:80px;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,0.04);flex:1}
        .stat-num{font-weight:800;font-size:18px}
        .stat-label{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;margin-top:3px}

        /* Search */
        .search-container{margin-bottom:14px;position:relative}
        .search-input{width:100%;padding:12px 12px 12px 42px;border-radius:28px;border:1px solid #e1e4e8;font-size:16px;box-sizing:border-box}
        .search-icon{position:absolute;left:14px;top:50%;transform:translateY(-50%);color:#888}

        /* Add box */
        .add-box{background:var(--card);padding:14px;border-radius:var(--radius);box-shadow:0 6px 16px rgba(0,0,0,0.04);margin-bottom:18px;border:1px solid #e9eef0}
        .section-title{font-weight:700;color:#222;margin-bottom:10px;font-size:15px;display:flex;align-items:center;gap:8px}
        .input-row{display:flex;gap:8px;margin-bottom:10px}
        input,select,button{font-size:14px}
        input,select{padding:10px;border:1px solid #e1e4e8;border-radius:8px;background:#fbfbfc;outline:none}
        input:focus,select:focus{border-color:var(--accent);background:white}
        .add-btn{background:#000;color:#fff;border:none;padding:12px;border-radius:8px;font-weight:700;cursor:pointer}

        /* Candidate card */
        .card{background:var(--card);border-radius:12px;padding:14px;margin-bottom:12px;display:flex;flex-direction:column;box-shadow:0 2px 6px rgba(0,0,0,0.03);border-left:6px solid #e0e0e0}
        .card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
        .name{font-weight:700;font-size:17px;color:#111}
        .phone{font-family:monospace;color:#555;margin-top:6px}
        .note-area{margin-top:8px;display:flex;align-items:center;gap:8px}
        .extra-note{font-size:12px;color:#444;background:#f1f1f1;padding:3px 8px;border-radius:6px}
        .edit-icon{cursor:pointer;font-size:13px;padding:4px 8px;border-radius:6px;border:1px solid #ddd;background:white}

        .tag-container{display:flex;gap:6px;align-items:center}
        .branch-tag{font-size:11px;padding:4px 8px;border-radius:6px;font-weight:700;color:#444;border:1px solid #e5e7ea;background:#fafafb}
        .badge{font-size:11px;padding:5px 8px;border-radius:12px;font-weight:800;color:#fff;text-transform:uppercase}
        .bg-zomato{background:#cb202d}
        .bg-swiggy{background:#fc8019}
        .bg-shadowfax{background:#00cba9;color:#023}
        .bg-instamart{background:#ff5200}
        .bg-zepto{background:#4b0082}
        .bg-rapido{background:#f9d310;color:#111}
        .bg-blinkit{background:#f8cb00;color:#111}
        .bg-porter{background:#2962ff}
        .bg-uber{background:#000}
        .bg-da{background:#1565c099;color:#fff}

        .action-row{display:flex;gap:10px;margin-top:12px;align-items:center}
        .status-select{flex-grow:1;padding:8px;border-radius:8px;border:1px solid #ddd;height:42px}
        .call-btn{background:#28a745;color:#fff;width:52px;height:42px;border-radius:8px;display:flex;align-items:center;justify-content:center;text-decoration:none;font-size:20px}

        .controls{display:flex;gap:8px;margin-top:8px}
        .download-btn{background:#343a40;color:white;border:none;padding:12px;border-radius:30px;font-weight:700;cursor:pointer}
        .small-btn{padding:8px 10px;border-radius:8px;border:1px solid #e3e6e8;background:white;cursor:pointer}

        /* Status styles */
        .st-interested{border-left-color:#28a745;background:#f0fff4}
        .st-office{border-left-color:#6f42c1;background:#f3e5f5}
        .st-training{border-left-color:#17a2b8;background:#e0f7fa}
        .st-working{border-left-color:#007bff;background:#e3f2fd}
        .st-busy{border-left-color:#6c757d;background:#f8f9fa}
        .st-no-answer{border-left-color:#ffc107;background:#fffdf5}
        .st-not-interested{border-left-color:#dc3545;opacity:0.8}

        /* Responsive */
        @media (max-width:640px){.input-row{flex-direction:column}.tag-container{flex-wrap:wrap}}

        /* Table preview */
        .preview-table{width:100%;border-collapse:collapse;margin-top:12px}
        .preview-table th, .preview-table td{border:1px solid #e6e6e6;padding:8px;text-align:left;font-size:13px}
        .file-row{display:flex;gap:8px;align-items:center}
    </style>
</head>
<body>

    <div class="dashboard">
        <div class="stat-card"><div class="stat-num" id="c-total">0</div><div class="stat-label">Total</div></div>
        <div class="stat-card" style="color:#6f42c1"><div class="stat-num" id="c-office">0</div><div class="stat-label">Office</div></div>
        <div class="stat-card" style="color:#28a745"><div class="stat-num" id="c-interested">0</div><div class="stat-label">Interest</div></div>
        <div class="stat-card" style="color:#17a2b8"><div class="stat-num" id="c-training">0</div><div class="stat-label">Training</div></div>
        <div class="stat-card" style="color:#ffc107"><div class="stat-num" id="c-na">0</div><div class="stat-label">No Ans</div></div>
    </div>

    <div class="search-container" role="search">
        <div class="search-icon">üîç</div>
        <input aria-label="Search candidates" type="search" id="searchInput" class="search-input" placeholder="Search Name, Phone, Branch, or Status..." />
    </div>

    <div class="add-box" aria-labelledby="addTitle">
        <div class="section-title" id="addTitle">‚ûï Add New Candidate</div>

        <div class="input-row">
            <input type="text" id="newName" placeholder="Name" style="flex:2" autocomplete="name" />
            <input type="tel" id="newPhone" placeholder="Phone (10 digits)" style="flex:3" inputmode="tel" pattern="[0-9]{10}" />
        </div>

        <div class="input-row">
            <select id="newCompany" style="flex:2">
                <option>Zomato</option>
                <option>Swiggy</option>
                <option>Shadowfax</option>
                <option>Instamart</option>
                <option>Zepto</option>
                <option>Blinkit</option>
                <option>Rapido</option>
                <option>Uber</option>
                <option>DA</option>
            </select>
            <select id="newBranch" style="flex:1; font-weight:bold; color:#555">
                <option>NLRD</option>
                <option>XAPE</option>
                <option>NLRM</option>
                <option>NLRA</option>
                <option>NLRG</option>
            </select>
        </div>

        <div class="input-row">
            <input type="text" id="newNote" placeholder="Extra Note (e.g. Has Bike)" />
        </div>

        <div style="display:flex;gap:8px">
            <button id="addBtn" class="add-btn">Add to List</button>
            <button id="clearBtn" class="small-btn" title="Clear form">Clear</button>
        </div>
    </div>

    <div class="file-row">
        <label for="fileInput">üìÅ Upload Excel/CSV:</label>
        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" />
        <button id="importBtn" class="small-btn">Import to List</button>
        <button id="previewBtn" class="small-btn">Preview Only</button>
    </div>

    <div id="previewArea"></div>

    <div id="candidate-list" aria-live="polite"></div>

    <div class="controls">
        <button id="downloadVcf" class="download-btn">üì• Download All Contacts (VCF)</button>
        <button id="downloadCsv" class="small-btn">‚¨áÔ∏è Export CSV</button>
        <button id="clearAll" class="small-btn">üßπ Clear All (local)</button>
    </div>

<script>
    // ---------- Utilities ----------
    const qs = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));

    function debounce(fn, wait=250){ let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn.apply(this,args), wait); }; }

    const STORAGE_KEY = 'hiring_manager_v1';

    const sample = [
        { name: "Kalyan", phone: "9493061306", company: "DA", branch: "NLRD", note: "Training 21/11", status: "pending" },
        { name: "Rajesh", phone: "8639176007", company: "DA", branch: "XAPE", note: "Training 21/11", status: "pending" },
        { name: "Rahaman", phone: "9573148671", company: "DA", branch: "NLRD", note: "", status: "pending" },
        { name: "Kishore", phone: "7093704548", company: "DA", branch: "NLRA", note: "", status: "pending" },
        { name: "Dayakar", phone: "8897208841", company: "Zomato", branch: "NLRD", note: "Full Time", status: "pending" }
    ];

    let candidates = load() || sample.slice();

    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(candidates)); }
    function load(){ try{ const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : null; }catch(e){return null} }

    // ---------- Render ----------
    const listContainer = qs('#candidate-list');

    function getBadgeClass(company){
        const co = (company||'').toLowerCase();
        if(co.includes('zomato')) return 'bg-zomato';
        if(co.includes('swiggy')) return 'bg-swiggy';
        if(co.includes('shadow')) return 'bg-shadowfax';
        if(co.includes('insta')) return 'bg-instamart';
        if(co.includes('zepto')) return 'bg-zepto';
        if(co.includes('rapido')) return 'bg-rapido';
        if(co.includes('blinkit')) return 'bg-blinkit';
        if(co.includes('uber')) return 'bg-uber';
        if(co.includes('porter')) return 'bg-porter';
        return 'bg-da';
    }

    function escapeHTML(str){ return String(str||'').replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s])); }

    function render(){
        listContainer.innerHTML = '';
        const q = (qs('#searchInput').value||'').trim().toLowerCase();

        candidates.forEach((c, idx)=>{
            const hay = `${c.name} ${c.phone} ${c.branch} ${c.company} ${c.status} ${c.note}`.toLowerCase();
            if(q && !hay.includes(q)) return;

            const badgeClass = getBadgeClass(c.company);
            const statusClass = {
                'Interested':'st-interested', 'Not Interested':'st-not-interested', 'Not Answering':'st-no-answer',
                'Office Coming':'st-office','Training':'st-training','Working':'st-working','Busy':'st-busy'
            }[c.status] || '';

            const noteText = c.note ? c.note : 'Add note';
            const noteStyle = c.note ? 'extra-note' : 'edit-icon';

            const el = document.createElement('div');
            el.className = 'card ' + statusClass;
            el.innerHTML = `
                <div class="card-header">
                    <div style="width:100%">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <div>
                                <div class="name">${escapeHTML(c.name)}</div>
                                <div class="phone">${escapeHTML(c.phone)}</div>
                            </div>
                            <div class="tag-container">
                                <span class="branch-tag">${escapeHTML(c.branch)}</span>
                                <span class="badge ${badgeClass}">${escapeHTML(c.company)}</span>
                                <button class="small-delete small-btn" data-idx="${idx}" title="Delete">üóëÔ∏è</button>
                            </div>
                        </div>

                        <div class="note-area">
                            <span class="${noteStyle}">${escapeHTML(noteText)}</span>
                            <button class="edit-icon" data-edit="${idx}">‚úèÔ∏è</button>
                        </div>
                    </div>
                </div>

                <div class="action-row">
                    <select class="status-select" data-idx="${idx}">
                        <option value="pending">Status...</option>
                        <option value="Interested">‚úÖ Interested</option>
                        <option value="Office Coming">üè¢ Office Coming</option>
                        <option value="Training">üéì Training</option>
                        <option value="Working">üíº Working</option>
                        <option value="Busy">‚è≥ Busy</option>
                        <option value="Not Answering">‚ö†Ô∏è Not Answering</option>
                        <option value="Not Interested">‚ùå Not Interested</option>
                    </select>
                    <a href="tel:${encodeURIComponent(c.phone)}" class="call-btn" aria-label="Call ${escapeHTML(c.name)}">üìû</a>
                </div>
            `;

            listContainer.appendChild(el);
            const sel = el.querySelector('.status-select'); if(sel) sel.value = c.status || 'pending';
        });

        attachDelegatedListeners();
        updateDashboard();
        save();
    }

    function attachDelegatedListeners(){
        qsa('.small-delete').forEach(btn=>{ btn.onclick = ()=>{ const i = Number(btn.dataset.idx); if(confirm('Delete '+candidates[i].name+' ?')){ candidates.splice(i,1); render(); } }; });
        qsa('[data-edit]').forEach(b=>{ b.onclick = ()=>{ const i = Number(b.getAttribute('data-edit')); const val = prompt('Edit note for '+candidates[i].name, candidates[i].note||''); if(val!==null){ candidates[i].note = val.trim(); render(); } }; });
        qsa('.status-select').forEach(s=>{ s.onchange = ()=>{ const i = Number(s.dataset.idx); candidates[i].status = s.value; render(); }; });
    }

    function updateDashboard(){
        qs('#c-total').innerText = candidates.length;
        qs('#c-office').innerText = candidates.filter(c=>c.status==='Office Coming').length;
        qs('#c-interested').innerText = candidates.filter(c=>c.status==='Interested').length;
        qs('#c-training').innerText = candidates.filter(c=>c.status==='Training').length;
        qs('#c-na').innerText = candidates.filter(c=>c.status==='Not Answering').length;
    }

    // ---------- File import (CSV / XLSX) ----------
    // We'll use SheetJS (xlsx) from CDN to parse .xlsx/.xls. CSV is parsed locally.
    // If offline, CSV will still work.

    function parseCSV(text){
        const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);
        const rows = lines.map(line => {
            // basic CSV split supporting quoted values
            const cells = [];
            let cur = '';
            let inQuotes = false;
            for(let i=0;i<line.length;i++){
                const ch = line[i];
                if(ch === '"') { inQuotes = !inQuotes; continue; }
                if(ch === ',' && !inQuotes){ cells.push(cur); cur = ''; continue; }
                cur += ch;
            }
            cells.push(cur);
            return cells.map(c=>c.trim());
        });
        return rows;
    }

    function rowsToCandidates(rows){
        // Expect header row with columns like: Name,Phone,Company,Branch,Note,Status
        const header = (rows[0]||[]).map(h=>String(h||'').toLowerCase());
        const idx = (name)=>{ const p = header.indexOf(name); return p>=0?p:-1; };
        const out = [];
        for(let r=1;r<rows.length;r++){
            const row = rows[r];
            if(!row || row.length === 0) continue;
            const name = row[idx('name')] || row[0] || '';
            const phone = (row[idx('phone')] || row[1] || '').toString().replace(/\D/g,'').slice(0,10);
            const company = row[idx('company')] || '';
            const branch = row[idx('branch')] || '';
            const note = row[idx('note')] || '';
            const status = row[idx('status')] || 'pending';
            if(!name && !phone) continue;
            out.push({ name: String(name), phone: String(phone), company: String(company), branch: String(branch), note: String(note), status });
        }
        return out;
    }

    // Load SheetJS dynamically when needed
    let xlsxLoaded = false;
    function loadXLSX(cb){
        if(window.XLSX){ xlsxLoaded = true; cb(); return; }
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js';
        s.onload = ()=>{ xlsxLoaded = true; cb(); };
        s.onerror = ()=>{ alert('Failed to load XLSX library. Make sure you have internet connection to import .xlsx files.'); };
        document.head.appendChild(s);
    }

    function handleFile(file, previewOnly=false){
        if(!file) return;
        const name = file.name.toLowerCase();
        const reader = new FileReader();
        if(name.endsWith('.csv')){
            reader.onload = (e)=>{
                const text = e.target.result;
                const rows = parseCSV(text);
                const candidatesFromFile = rowsToCandidates(rows);
                showPreview(rows, candidatesFromFile, previewOnly);
            };
            reader.readAsText(file);
        } else if(name.endsWith('.xlsx') || name.endsWith('.xls')){
            loadXLSX(()=>{
                reader.onload = (e)=>{
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type:'array'});
                    const firstSheet = workbook.SheetNames[0];
                    const ws = workbook.Sheets[firstSheet];
                    const rows = XLSX.utils.sheet_to_json(ws, {header:1});
                    const candidatesFromFile = rowsToCandidates(rows);
                    showPreview(rows, candidatesFromFile, previewOnly);
                };
                reader.readAsArrayBuffer(file);
            });
        } else {
            alert('Unsupported file type. Use .csv, .xlsx or .xls');
        }
    }

    function showPreview(rows, parsedCandidates, previewOnly){
        const previewArea = qs('#previewArea');
        // Build table from first 20 rows
        const max = Math.min(rows.length, 20);
        let html = '<div style="margin-top:12px">';
        html += `<div style="font-size:13px;margin-bottom:8px">Preview ‚Äî ${rows.length} rows parsed. Showing first ${max} rows.</div>`;
        html += '<table class="preview-table"><thead><tr>';
        const headers = rows[0] || [];
        for(const h of headers) html += `<th>${escapeHTML(h||'')}</th>`;
        html += '</tr></thead><tbody>';
        for(let r=1;r<Math.min(rows.length, 21); r++){
            html += '<tr>';
            for(const cell of rows[r]) html += `<td>${escapeHTML(cell||'')}</td>`;
            html += '</tr>';
        }
        html += '</tbody></table>';
        html += `<div style="margin-top:10px;display:flex;gap:8px"><button id="confirmImport" class="small-btn">Import ${parsedCandidates.length} rows</button> <button id="cancelPreview" class="small-btn">Cancel</button></div>`;
        html += '</div>';
        previewArea.innerHTML = html;

        qs('#confirmImport').onclick = ()=>{ // merge into candidates
            // add only non-duplicate phones (by exact match)
            let added = 0;
            parsedCandidates.forEach(pc=>{
                if(!pc.phone && !pc.name) return;
                const exists = candidates.some(c=>c.phone === pc.phone && pc.phone);
                if(!exists){ candidates.unshift(pc); added++; }
            });
            save(); render(); alert(`Imported ${added} new rows (${parsedCandidates.length - added} duplicat